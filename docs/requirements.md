# minimal-phoneme-tts 要件定義書

**Date**: 2026年1月15日  
**Project**: 少量音素コーパスを用いた日本語TTS構築実験  
**Repository**: minimal-phoneme-tts  
**Version**: 1.0

---

## 1. プロジェクト概要

### 1.1 研究背景
日本語コーパス100文中に37種類のユニーク音素が存在し、貪欲法により4文で全音素をカバーできることを確認済み。前回実験では音声合成に失敗し品質評価まで到達できなかった課題がある。

### 1.2 研究目的
- **主目的**: 音素カバレッジとコーパス設計（4文 vs 80文など）が、fine-tuningされた日本語TTSモデルの出力品質に与える影響を、客観指標（MCD, F0 RMSE, CER）を用いて明らかにする
- **技術目標**: 少量日本語コーパスを用いたTTS fine-tuningパイプライン（前処理→学習→合成→評価）を自力で構築・運用できるようになる

### 1.3 MVP定義
事前学習済み日本語TTSモデルを利用し、以下4条件のコーパスでfine-tuning→合成→客観評価まで到達すること:
1. 80文コーパス（学習用）
2. 37音素を全カバーする4文コーパス
3. ランダムに選んだ4文コーパス
4. 音素特徴量上位10文コーパス

---

## 2. 要件定義

### 2.1 機能要件

#### 2.1.1 主要機能一覧
| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F01 | 音素分析 | 100文コーパスから37音素インベントリと各文の音素分布を抽出・保存 |
| F02 | コーパス選定 | 4条件（80文/37音素4文/ランダム4文/上位10文）の文IDリスト生成 |
| F03 | データ前処理 | JVS parallel100 jvs002話者データの前処理パイプライン |
| F04 | Fine-tuning | 各条件でのモデル学習実行スクリプト |
| F05 | 音声合成 | テスト文からの音声生成 |
| F06 | 客観評価 | MCD/log-F0 RMSE/CER算出 |
| F07 | 結果可視化 | 評価指標の比較図表生成 |
| F08 | ログ管理 | 実験ログ・中間結果の記録 |

#### 2.1.2 ユーザーストーリー

**Problem Statement（課題）**
```
従来の音声合成モデル構築には以下の課題がある:
- モデル学習に長時間（数日〜数週間）を要する
- 高品質な音声合成には数千〜数万文の大量録音データが必要
- データ収集コストが高い（収録時間、設備費用、話者への報酬）
- 個人が自声TTSを作る際のハードルが非常に高い
```

**Solution（解決策）**
```
音素カバレッジに基づく最小限コーパス設計により、
時間短縮とデータ収集コストの削減を実現する。

具体的には:
- 37音素を4文でカバーする最小限のコーパス設計
- Fine-tuningによる学習時間の短縮（数時間〜1日以内）
- 少量データでの品質評価により、実用可能な最小データ量を特定
```

**User Story**
```
As a researcher (or individual who wants to create personal TTS),
I want to understand the minimum corpus size required for acceptable TTS quality,
So that I can reduce recording time from weeks to hours and minimize data collection costs.

Given: JVS parallel100 corpus with 100 sentences containing 37 unique phonemes
When: I run fine-tuning experiments with 4 different corpus conditions
  - 80 sentences (baseline with maximum data)
  - 4 sentences covering all 37 phonemes (minimum phoneme coverage)
  - 4 random sentences (control group)
  - Top 10 sentences by phoneme features (balanced approach)
Then: I get objective metrics (MCD, F0 RMSE, CER) comparing quality vs corpus size
And: I can synthesize audio files demonstrating the quality difference
And: I can determine the practical minimum corpus size for acceptable TTS quality
And: I can establish guidelines for efficient corpus design in future TTS projects
```

**Expected Impact（期待される効果）**
- **時間短縮**: データ収集時間を数週間→数時間に削減
- **コスト削減**: 最小限の録音セッションで実用的な品質を達成
- **アクセシビリティ向上**: 個人でも自声TTSを現実的に構築可能に
- **研究貢献**: 音素カバレッジと品質の関係を定量的に示す

---

### 2.2 非機能要件

#### パフォーマンス
- Fine-tuning時間: 80文=5-10k steps、4文/10文=1-3k steps
- 合成速度: テスト文10-20文を30分以内で合成完了
- GPU使用率: RTX 4070 Ti (12GB VRAM) の効率的利用

#### 可用性
- 実験再現性: すべての乱数シードを固定し、同一結果を保証
- 中断耐性: 学習中断時にチェックポイントから再開可能

#### ユーザビリティ
- CLI実行: シンプルなコマンドで各実験を実行
- ログ出力: 進捗状況をリアルタイムで確認可能
- エラーハンドリング: わかりやすいエラーメッセージ

#### 拡張性
- 新しいコーパス条件の追加が容易
- 評価指標の追加が容易
- 他の事前学習モデルへの切り替えが可能

### 2.3 技術要件

#### 技術スタック
- **言語**: Python 3.12.9
- **深層学習フレームワーク**: PyTorch
- **TTS基盤**: ESPnet2-TTS（第一候補）、StyleTTS2（第二候補）
- **音素解析**: pyopenjtalk
- **評価**: ESPnet2評価スクリプト、ASR (Whisper/ESPnet2-ASR)
- **可視化**: matplotlib, seaborn
- **依存管理**: requirements.txt

#### 開発環境
- **OS**: WSL2 Ubuntu 24.04
- **GPU**: RTX 4070 Ti (12GB VRAM)
- **メモリ**: 64GB RAM
- **IDE**: Cursor (リモートエクスプローラー経由)
- **バージョン管理**: Git/GitHub（パブリックリポジトリ）

#### データ
- **コーパス**: JVS parallel100 - jvs002話者（100文）
- **音素数**: 37種類のユニーク音素
- **分割**: 学習80文/テスト20文（または各条件で未学習のテスト文10-20文）

### 2.4 制約条件

#### 期間制約
- **完了期限**: 2026年1月22日まで（残り7日間）
- **フェーズ構成**:
  - 環境構築・データ準備: 1/15-1/16 (2日)
  - Fine-tuning実験: 1/17-1/19 (3日)
  - 評価・分析: 1/20-1/21 (2日)
  - ドキュメント整備: 1/22 (1日)

#### リソース制約
- 単独開発（1名）
- ローカルGPU環境のみ（クラウド不使用）
- 学習時間が長くなりすぎないよう、fine-tuningステップ数とバッチサイズに上限設定

#### ビジネス制約
- 卒論・学会発表用途のため学術的厳密性が必要
- 再現可能性の確保が必須
- ライセンス: 未設定（研究用途のため）

### 2.5 リスクと対応方針

| リスク | 影響度 | 対応方針 |
|--------|--------|----------|
| ESPnet2環境構築失敗 | 高 | StyleTTS2へ早期切り替え。Docker環境も検討 |
| Fine-tuning時間超過 | 中 | ステップ数削減、バッチサイズ調整、条件数削減 |
| 音声合成品質不足 | 中 | ハイパーパラメータ調整、事前学習モデル変更 |
| GPU OOM | 中 | バッチサイズ削減、mixed precision使用 |
| 期限超過 | 高 | 優先度順に機能削減、最低限MVPを確保 |

---

## 3. AI駆動開発の4つの問い

### 3.1 Why: なぜAIを使うのか？

#### AI活用の目的
1. **開発速度向上**: 7日間という短期間で、データ前処理・学習・評価の全パイプラインを構築する必要がある
2. **技術知識の補完**: ESPnet2の複雑な設定ファイルや、音響評価指標の実装に関する専門知識をAIで補完
3. **コード品質向上**: PyTorchやESPnet2のベストプラクティスに沿った実装をAIが提案
4. **ドキュメント効率化**: 実験ログ、README、結果レポートの下書きを自動生成

#### AI不使用の場合との比較
- 手動実装では2-3週間かかる内容を7日間で完成させる
- ESPnet2の公式ドキュメント理解に時間をかけず、実装に集中できる
- エラーデバッグ時間を短縮し、実験反復速度を向上

### 3.2 What: AIが担うのは何か？

#### AIが担当する領域
- **コード生成**:
  - 音素分析スクリプト（F01）
  - データ前処理パイプライン（F03）
  - Fine-tuningスクリプト（F04）
  - 評価スクリプト（F06）
  - 可視化スクリプト（F07）
- **設定ファイル生成**:
  - ESPnet2 YAML設定
  - シェルスクリプト（実験実行用）
- **ドキュメント下書き**:
  - README.md
  - 実験ログテンプレート
  - コード内docstring

#### 人間（自分）が必ず判断・実装する領域
- **実験設計**: 4条件の選定基準、音素特徴量の定義
- **品質評価の解釈**: 客観指標から得られる知見の分析
- **ハイパーパラメータ最終決定**: 学習率、ステップ数、バッチサイズの調整
- **論文執筆**: 結果の学術的考察と執筆
- **エラーの根本原因特定**: AI生成コードがエラーを起こした際の原因分析

#### 協働が必要な領域
- **アーキテクチャ設計**: ESPnet2 vs StyleTTS2の選定
- **評価指標選定**: MCD/F0 RMSE/CERの計算方法確認
- **パフォーマンス最適化**: GPU使用率、メモリ効率の改善
- **実験計画調整**: 期限内に完了させるための条件削減判断

#### AIから人間へバトンを渡すポイント
1. **コード生成後**: 必ず動作確認とコードレビューを実施
2. **学習開始前**: 設定ファイルの最終確認
3. **エラー発生時**: エラーログを確認し、根本原因を自分で特定
4. **評価完了時**: 数値結果の妥当性チェックと解釈
5. **ドキュメント生成後**: 技術的正確性と論理性の検証

### 3.3 How: どう管理・運用するか？

#### バージョン管理とAIコードのトレース方法
- **リポジトリ**: `minimal-phoneme-tts`（GitHub パブリックリポジトリ）
- **コミットルール**:
  - AI生成: `AI: <機能名> - <簡単な説明>`
  - 人間修正: `Fix: <修正内容>`
  - 実験実行: `Exp: <条件名> - <実験日時>`
- **ブランチ戦略**:
  - `main`: 安定版
  - `dev`: 開発中
  - `exp/<condition>`: 各実験条件専用
- **AIコードのタグ付け**: コメントに `# Generated by AI (Perplexity/Cursor)` を記載

#### 品質管理

**AI生成コードのレビュー基準**:
- [ ] 構文エラーがないか
- [ ] 依存ライブラリが適切にインポートされているか
- [ ] ファイルパス、ディレクトリ構造が想定通りか
- [ ] エラーハンドリングが実装されているか
- [ ] ログ出力が適切か
- [ ] GPU/CPU判定が正しいか
- [ ] 乱数シード固定が実装されているか

**最低限の自動テスト方針**:
- 単体テスト: 音素分析、コーパス選定ロジック
- 統合テスト: データ前処理→学習→合成→評価の全パイプライン
- 煙テスト: 各スクリプトが最低限エラーなく起動するか

#### 知識管理
- **Perplexity対話ログ**: Notion「.Development.AI.Project.TTS」に保存
- **良かったプロンプト**: `docs/prompts.md` に記録
- **実験ログ**: `logs/YYYYMMDD_<condition>.md` 形式で日次保存
- **振り返りログ**: `docs/retrospective.md` に週次まとめ
- **設計メモ**: `docs/design_memo.md` にタスク分解と実験設計を記録
- **PDCAチェック表**: `docs/pdca_checklist.md` で進捗管理

### 3.4 What-if: 不確実性/失敗にどう備えるか？

#### AIがミスったときの共通ルール
1. **小さい単位で検証**: 1機能ごとにコード動作確認
2. **重要機能は必ず自分でコードを読む**: Fine-tuning、評価スクリプト
3. **公式ドキュメント確認**: ESPnet2の設定項目、pyopenjtalkの出力形式
4. **段階的実装**: いきなり全機能を任せず、小規模テストから開始

#### 想定する失敗パターンと対策

| 失敗パターン | 対策 |
|--------------|------|
| **誤ったコード生成** | • テスト実行必須<br>• コードレビュー（特にパス、型、ロジック）<br>• 小規模データでの動作確認 |
| **古い情報に基づく提案** | • ESPnet2/StyleTTS2の公式GitHub最新版を確認<br>• エラー発生時は公式issueを検索 |
| **一貫性のない設計** | • 定期的に設計レビュー（1/17, 1/19, 1/21）<br>• `docs/design_memo.md` で設計方針を明文化 |
| **依存関係の不整合** | • requirements.txt を段階的に更新<br>• 仮想環境で隔離して検証 |
| **GPU OOM** | • バッチサイズを半分に削減<br>• mixed precision (fp16) を有効化<br>• gradient accumulation使用 |
| **学習が収束しない** | • 学習率を1/10に下げる<br>• 事前学習モデルを変更<br>• ステップ数を増やす（期限内で調整） |
| **評価指標の計算エラー** | • 手動で1サンプル計算して検証<br>• ESPnet2公式評価スクリプトと比較 |

#### 期限リスクへの対応
- **1/18時点で進捗50%未満の場合**: 条件を4→3に削減（ランダム4文を除外）
- **1/20時点で評価未完了の場合**: MCD/F0のみに絞る（CERは削除）
- **1/21時点で分析未完了の場合**: 基本統計のみ、図表は最小限に

---

## 4. 成果物定義

### 4.1 コード一式
- `src/`: ソースコード
  - `phoneme_analysis.py`: 音素分析
  - `corpus_selection.py`: コーパス選定
  - `preprocess.py`: データ前処理
  - `train.py`: Fine-tuning
  - `synthesize.py`: 音声合成
  - `evaluate.py`: 客観評価
  - `visualize.py`: 結果可視化
- `scripts/`: 実行スクリプト
  - `run_experiment_80sent.sh`
  - `run_experiment_4sent_37phonemes.sh`
  - `run_experiment_4sent_random.sh`
  - `run_experiment_10sent_top.sh`
- `configs/`: 設定ファイル（YAML）
- `tests/`: テストコード

### 4.2 ドキュメント（Markdown）
- `README.md`: プロジェクト概要、環境構築手順、使用方法
- `docs/requirements.md`: 本要件定義書
- `docs/design_memo.md`: 設計メモ（タスク分解&実験設計）
- `docs/pdca_checklist.md`: PDCAチェック表
- `docs/retrospective.md`: 振り返りログ
- `docs/results.md`: 実験結果レポート

### 4.3 実験ログ・結果
- `logs/`: 日次実験ログ
- `results/`: 評価結果JSON/CSV
- `outputs/audio/`: 合成音声ファイル（WAV）
- `outputs/figures/`: 評価指標比較図表（PNG）

### 4.4 学会発表・卒論用資料
- 評価指標比較表
- 音素カバレッジと品質の関係グラフ
- サンプル音声ファイル（デモ用）

---

## 5. 次のステップ

要件定義書の作成が完了しました。次に以下のドキュメントを作成することをお勧めします:

1. **設計レベルメモ（タスク分解&実験設計）**
   - 各機能の詳細設計
   - タスクの優先度付け
   - 実装順序の決定

2. **PDCAチェック表**
   - 日次進捗確認項目
   - マイルストーン達成基準
   - リスク発生時の判断フロー

3. **振り返りログテンプレート**
   - 日次振り返り項目
   - うまくいったこと/改善点
   - 翌日の計画

---

## 変更履歴

| Date | Version | Changes |
|------|---------|---------|
| 2026-01-15 | 1.0 | 初版作成 |

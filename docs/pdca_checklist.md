# PDCAチェックリスト

**Date**: 2026年1月15日  
**Project**: 少量音素コーパスを用いた日本語TTS構築実験  
**Period**: 2026年1月15日 - 2026年1月22日（7日間）  
**Version**: 1.0

---

## プロジェクト概要

### 研究目的
音素カバレッジとコーパス設計（4文 vs 80文など）が、fine-tuningされた日本語TTSモデルの出力品質に与える影響を、客観指標（MCD, log-F0 RMSE, CER）を用いて明らかにする。

### 実験条件（4条件）
- **E1**: 80文コーパス（データ量最大）
- **E2**: 37音素4文（音素カバレッジ最大、データ量最小）
- **E3**: 低カバレッジ4文（対照群、目標20-25音素、約50-65%カバー）
- **E4**: 上位10文（音素特徴量上位）

### 学習設定（変更履歴）
- **max_epoch**: 100 → 20 → 10（時間制約のため変更、4文コーパス: 約45分、80文コーパスも実験可能）
- **batch_bins**: 3750000 → 500000（小規模コーパス用に削減、GPU OOM回避）

### 全体スケジュール
- **1/15-1/16 (2日)**: 環境構築・データ準備（Phase 1, 2）
- **1/17-1/19 (3日)**: Fine-tuning実験（Phase 3, 4）
- **1/20-1/21 (2日)**: 評価・分析（Phase 5, 6）
- **1/22 (1日)**: ドキュメント整備（Phase 7）

---

## マイルストーン確認表

| 日付 | マイルストーン | 達成基準 |
|------|---------------|----------|
| **1/16終了時点** | Phase 1, 2完了 | - ESPnet2/StyleTTS2が正常にインストール・動作確認済み<br>- JVS parallel100データが配置済み<br>- 音素分析完了、4条件のコーパス選定完了 |
| **1/18終了時点** | Phase 3完了、Phase 4最低2条件完了 | - データ前処理完了<br>- E1（80文）、E2（37音素4文）のfine-tuning完了 |
| **1/20終了時点** | Phase 4全条件、Phase 5, 6完了 | - 全4条件のfine-tuning完了<br>- 音声合成完了<br>- 客観評価（MCD, F0 RMSE）完了 |
| **1/22終了時点** | Phase 7完了、全ドキュメント整備 | - 結果可視化・分析完了<br>- 全ドキュメント整備完了 |

---

## リスク対応フロー

### 期限リスクへの対応
- **1/18時点で進捗50%未満の場合**: 条件を4→3に削減（E3（低カバレッジ4文）を除外）
- **1/20時点で評価未完了の場合**: MCD/F0のみに絞る（CERは削除）
- **1/21時点で分析未完了の場合**: 基本統計のみ、図表は最小限に

### 主要リスクと対応
- **ESPnet2環境構築失敗**: StyleTTS2へ早期切り替え
- **GPU OOM**: バッチサイズ削減、mixed precision (fp16)使用
- **学習が収束しない**: 学習率を1/10に下げる、ステップ数調整
- **合成音声が生成されない**: チェックポイント確認、モデル読み込み確認

---

## 日次PDCA

---

### 2026年1月15日（木）Day 1

#### Plan（計画）

**今日のゴール**
- Phase 1（環境構築・データ準備）の開始
- ESPnet2/StyleTTS2の選定と環境構築

**やるタスク**（設計レベルメモ Phase 1参照）
- [x] ESPnet2とStyleTTS2の比較調査（公式ドキュメント、日本語対応状況、評価スクリプトの有無）
- [x] TTS基盤の選定決定（ESPnet2優先、失敗時はStyleTTS2）
- [x] 既存venv環境の確認と有効化（`/home/gohan/.venv`、Python 3.12.9、PyTorch 2.5.1+cu121既存）
- [x] PyTorch動作確認（CUDA認識、GPU利用確認）※既にインストール済みのため確認のみ
- [x] requirements.txtの作成（TTS関連パッケージのみ記載）
- [x] ESPnet2のインストール（またはStyleTTS2）
- [x] 依存ライブラリのインストール（pyopenjtalk, librosa, soundfile, matplotlib, seaborn等）
- [x] JVS parallel100データのダウンロード・配置確認

**詰まりそうなポイント**
- ESPnet2環境構築失敗（影響度：高）→ StyleTTS2へ早期切り替え
- GPU認識不可（影響度：低）→ PyTorchは既にインストール済み、確認のみ実施

#### Do（実行）

実行ログ（時間＋内容）:
```
[2026-01-18] プロジェクト構造の確認、ディレクトリ作成
[2026-01-18] PyTorch動作確認（CUDA認識済み）
[2026-01-18] 依存ライブラリのインストール完了（pyopenjtalk, librosa, soundfile等）
[2026-01-18] src/phoneme_analysis.py作成完了
[2026-01-18] src/corpus_selection.py作成完了
[2026-01-18] src/preprocess.py作成完了
[2026-01-18] ESPnet2のインストール完了（pip install -e "./espnet[tts]"）
[2026-01-18] JVSデータの配置確認完了
[2026-01-18] ESPnet2動作確認完了（TTSモジュールインポート成功）
```

#### Check（確認）

**できたこと / できなかったこと**
- ✓ プロジェクト構造の作成（src/, scripts/, configs/, tests/, data/, results/, outputs/）
- ✓ PyTorch動作確認（CUDA 12.1認識済み）
- ✓ 依存ライブラリのインストール完了
- ✓ Phase 2のスクリプト作成完了（phoneme_analysis.py, corpus_selection.py）
- ✓ Phase 3のスクリプト作成完了（preprocess.py）
- ✓ ESPnet2のインストール完了（TTS機能付き）
- ✓ JVSデータの準備完了（ダウンロード・配置済み）


**想定との差分**
- スクリプト作成が順調に進んだため、Phase 2, 3のスクリプトを先に作成
- ESPnet2のインストールは想定通り完了（既存venvに直接インストール）
- JVSデータの準備はユーザーが事前に実施済み


#### Action（改善）

**次回変えること**
1. ✅ ESPnet2のインストール完了
2. ✅ JVS parallel100データの準備完了
3. 次のセッションで音素分析とコーパス選定を実行

---

### 2026年1月16日（金）Day 2

#### Plan（計画）

**今日のゴール**
- Phase 1完了、Phase 2（音素分析・コーパス選定）完了
- マイルストーン1達成

**やるタスク**（設計レベルメモ Phase 1, 2参照）
- [ ] 簡単な動作テスト（ESPnet2のサンプル実行またはStyleTTS2のデモ実行）
- [x] requirements.txtの作成・更新
- [x] `src/phoneme_analysis.py`の作成（音素ラベル抽出スクリプト）
- [ ] pyopenjtalkを使用した100文の音素列抽出（JVSデータ準備後に実行）
- [ ] 37音素インベントリの確認・リスト化（JVSデータ準備後に実行）
- [ ] 各文の音素分布（ユニーク音素数、頻度）を計算（JVSデータ準備後に実行）
- [ ] 音素分布データをJSON/CSV形式で保存（`results/phoneme_distribution.json`）（JVSデータ準備後に実行）
- [x] `src/corpus_selection.py`の作成（コーパス選定スクリプト）
- [ ] 4条件のコーパス選定（80文/37音素4文/低カバレッジ4文/上位10文）（JVSデータ準備後に実行）
- [ ] 4条件の文IDリストをJSON形式で保存（`results/corpus_selection.json`）（JVSデータ準備後に実行）

**詰まりそうなポイント**
- 37音素カバー4文が存在しない（影響度：中）→ 貪欲法を再実行、5文に拡張も検討
- 音素解析エラー（影響度：中）→ pyopenjtalkの設定確認、エラー文の除外

#### Do（実行）

実行ログ（時間＋内容）:
```
[2026-01-18] phoneme_analysis.pyの修正（テキストファイル読み込み、音素抽出）
[2026-01-18] 音素分析スクリプト実行完了（38音素インベントリ確認）
[2026-01-18] コーパス選定スクリプト実行完了（4条件のコーパス選定完了）
[2026-01-18] 結果ファイル保存完了（phoneme_distribution.json, corpus_selection.json）
```

#### Check（確認）

**できたこと / できなかったこと**
- ✓ pyopenjtalkを使用した100文の音素列抽出完了
- ✓ 38音素インベントリの確認・リスト化完了（pau含む）
- ✓ 各文の音素分布（ユニーク音素数、頻度）を計算完了
- ✓ 音素分布データをJSON/CSV形式で保存完了
- ✓ 4条件のコーパス選定完了（80文/37音素4文/低カバレッジ4文/上位10文）
- ✓ 4条件の文IDリストをJSON形式で保存完了
- ✓ テストセットの選定完了（18文）


**想定との差分**
- 音素インベントリが37音素ではなく38音素（pau含む）となった。これはpyopenjtalkの出力形式によるもので、問題なし
- E2（37音素4文）が実際には38音素をカバーしていることを確認。名称は「37音素4文」のまま維持（pauはポーズ音素として重要だが、実験設計上は37音素を想定）


#### Action（改善）

**次回変えること**
1. ✅ Phase 2完了、Phase 3（データ前処理）に進む
2. Phase 3でESPnet2形式のデータリスト生成を実行
3. Phase 4のfine-tuning準備を開始

---

### 2026年1月17日（土）Day 3

#### Plan（計画）

**今日のゴール**
- Phase 3（データ前処理）完了
- Phase 4（Fine-tuning実験）の準備開始

**やるタスク**（設計レベルメモ Phase 3, 4参照）
- [ ] `src/preprocess.py`の作成（データ前処理スクリプト）
- [ ] JVSデータの読み込み（音声ファイル、テキストファイルのパス取得）
- [ ] 音声ファイルの確認（サンプリングレート、チャンネル数、長さ）
- [ ] テキストから音素列への変換（pyopenjtalk使用）
- [ ] ESPnet2形式の`data.list`生成（音声パス、音素列、話者ID）
- [ ] 4条件それぞれの学習用データリスト生成
- [ ] テストセットのデータリスト生成（共通）
- [ ] `src/train.py`の作成（fine-tuningスクリプト）
- [ ] ESPnet2設定ファイル（YAML）の作成（またはStyleTTS2設定）
- [ ] 事前学習モデルのダウンロード・配置確認

**詰まりそうなポイント**
- データ形式変換エラー（影響度：中）→ ESPnet2公式ドキュメント確認、サンプルデータでテスト
- GPU OOM（影響度：中）→ バッチサイズ削減、mixed precision (fp16)使用

#### Do（実行）

実行ログ（時間＋内容）:
```
[2026-01-18] preprocess.pyの修正（テキスト読み込み、音素抽出）
[2026-01-18] データ前処理スクリプト実行完了（4条件すべてのデータリスト生成）
[2026-01-18] ESPnet2のfine-tuning方法の調査（JVSレシピ、tts_train.py確認）
[2026-01-18] Phase 4のPlan作成（docs/phase4_plan.md）
```

#### Check（確認）

**できたこと / できなかったこと**
- ✓ JVSデータの読み込み完了（音声ファイル、テキストファイルのパス取得）
- ✓ 音声ファイルの確認完了（24kHz、モノラル、正常に読み込み可能）
- ✓ テキストから音素列への変換完了（pyopenjtalk使用、kana=False）
- ✓ ESPnet2形式のdata.list生成完了（4条件すべて）
- ✓ テストセットのデータリスト生成完了
- ✓ ESPnet2のfine-tuning方法の調査完了
- ⚠️ ESPnet2形式（Kaldi形式）への変換が必要（次のステップ）


**想定との差分**
- データ形式がESPnet2のKaldi形式ではなく、独自のJSONL形式（data.list）で生成した
- ESPnet2のfine-tuningにはKaldi形式（wav.scp, text, utt2spk等）が必要であることを確認
- データ形式変換スクリプトの作成が必要


#### Action（改善）

**次回変えること**
1. ✅ Phase 3完了、Phase 4のPlan作成完了
2. Phase 4でESPnet2形式へのデータ変換スクリプトを作成
3. ESPnet2の設定ファイル（YAML）を作成
4. 事前学習モデルのダウンロード

---

### 2026年1月18日（日）Day 4

#### Plan（計画）

**今日のゴール**
- Phase 4の最低2条件（E1, E2）のfine-tuning完了
- マイルストーン2達成

**やるタスク**（設計レベルメモ Phase 4参照）
- [x] E3コーパス選定方法の変更（ランダム→低カバレッジ、25音素達成）
- [x] Phase 3完了確認（データ検証、E3カバレッジ確認）
- [x] ESPnet2形式へのデータ変換スクリプト作成（`src/convert_to_espnet2_format.py`）
- [x] 4条件すべてとテストセットのESPnet2形式変換完了
- [x] 設定ファイル作成（`configs/finetune_tacotron2.yaml`）
- [x] 学習スクリプトの実装（チェックポイント保存、ログ出力、--resume対応）
- [x] 乱数シード固定の実装（train.pyに既存）
- [x] バッチサイズの決定（batch_bins: 3750000 → 500000に削減、GPU OOM回避成功）
- [x] 学習率の設定確認（設定ファイルに記載済み）
- [x] 設定ファイルの完成（token_list, normalize, feats_extract, g2p, cleaner追加）
- [x] 学習進捗監視スクリプト作成（`scripts/check_progress.sh`, `scripts/monitor_training.sh`）
- [x] 自動再開スクリプト作成（`scripts/train_with_auto_resume.sh`）
- [x] E2（37音素4文）のfine-tuning小規模テスト実行
- [x] max_epochを10に変更（時間制約のため、100から10に削減、80コーパスも実験可能）
- [ ] E1（80文）のfine-tuning実行
- [ ] E3（低カバレッジ4文）のfine-tuning実行
- [ ] E4（上位10文）のfine-tuning実行

**詰まりそうなポイント**
- GPU OOM（影響度：中）→ バッチサイズ削減、mixed precision (fp16)使用、gradient accumulation
- 学習が収束しない（影響度：中）→ 学習率を1/10に下げる、ステップ数を増やす
- Fine-tuning時間超過（影響度：高）→ ステップ数削減、条件数削減（ランダム4文を除外）

#### Do（実行）

実行ログ（時間＋内容）:
```
[2026-01-18] E3コーパス選定方法の変更（ランダム→低カバレッジ選定）
[2026-01-18] corpus_selection.pyのselect_random_4_sentences()関数を変更
[2026-01-18] コーパス選定スクリプト再実行、E3のカバレッジが25音素（約65.8%）に
[2026-01-18] ドキュメント更新（pdca_checklist.md, design_memo.md, requirements.md）
[2026-01-18] Phase 3データ検証完了（E3カバレッジ確認、data.listファイル確認）
[2026-01-18] src/convert_to_espnet2_format.py作成・実行完了
[2026-01-18] 4条件すべてとテストセットをESPnet2形式（Kaldi形式）に変換完了
[2026-01-18] configs/finetune_tacotron2.yaml作成完了（JVSレシピベース）
[2026-01-18] Phase 4実装開始：train.pyに学習実行機能を追加予定（subprocessでespnet2.bin.tts_trainを呼び出し、各条件をループ処理、統計情報収集とFine-tuningの2ステップ実行、学習時間記録機能追加予定）
[2026-01-19] train.pyの実装完了（ESPnet2のtts_train.py呼び出し、全条件ループ処理、統計情報収集とFine-tuningの2ステップ実行、学習時間記録機能を実装）
[2026-01-19] 事前学習モデルのダウンロード実行（ESPnet model zooからkan-bayashi/jsut_tacotron2_accent_with_pauseをダウンロード、downloads/ディレクトリに保存）
[2026-01-19] train.pyのデフォルトパスを実際のダウンロード後のパス構造に更新（動的検索機能も追加）
[2026-01-19] .gitignoreでdownloads/が無視されることを確認（Gitコミットの心配なし）
[2026-01-19] E2（train_4sent_37phonemes）でfine-tuningの小規模テスト実行開始
[2026-01-19] 統計情報収集（Step 1）成功（exp/train_4sent_37phonemes/stats/に統計ファイル生成）
[2026-01-19] 設定ファイルにtoken_list追加（事前学習モデルと同じ85トークン）
[2026-01-19] 設定ファイルにnormalize, feats_extract, g2p, cleaner設定追加
[2026-01-19] train.pyにstats_fileとshape_file自動設定機能追加
[2026-01-19] 統計情報収集時のnormalize: null設定追加
[2026-01-19] GPU OOM発生 → batch_binsを3750000から500000に削減（約1/7.5に削減）
[2026-01-19] batch_bins削減後、GPU VRAM使用量が約11.5GB（93.6%）に安定、クラッシュ回避成功
[2026-01-19] Epoch 1完了（Loss: train=4.323, valid=2.764、所要時間: 約4分39秒）
[2026-01-19] Epoch 2完了（Loss: train=3.093, valid=2.523、所要時間: 約4分16秒）
[2026-01-19] WSL環境のシンボリックリンク制限によるPermissionError発生（latest.pth作成時）
[2026-01-19] 学習停止問題の調査・分析完了（docs/training_issue_analysis.md作成）
[2026-01-19] train.pyに--resumeオプション自動追加機能実装（チェックポイント存在時）
[2026-01-19] 学習進捗監視スクリプト作成（scripts/check_progress.sh, scripts/monitor_training.sh）
[2026-01-19] 自動再開スクリプト作成（scripts/train_with_auto_resume.sh）
[2026-01-19] max_epochを100から20に変更（時間制約と実験効率化のため）
[2026-01-19] max_epochを20から10に変更（80コーパスも対照実験として実行するため、すべての条件で同じエポック数に統一）
[2026-01-19 23:37] 連続実行スクリプト作成（scripts/run_all_remaining_conditions.sh, scripts/check_all_progress.sh）
[2026-01-19 23:37] 残り3条件（E3, E4, E1）の連続実行開始（バックグラウンド実行）
[2026-01-20 00:14] E3（train_4sent_random）完了（所要時間: 37分46秒、10エポック達成）
[2026-01-20 01:11] E4（train_10sent_top）完了（所要時間: 56分9秒、10エポック達成）
[2026-01-20 01:48] E1（train_80sent）完了（所要時間: 37分40秒、10エポック達成）
[2026-01-20 01:49] 全条件実行完了（成功: 3/3、総所要時間: 約2時間12分）
```

#### Check（確認）

**できたこと / できなかったこと**
- ✓ E3コーパス選定方法の変更完了（25音素、約65.8%カバー、目標範囲内）
- ✓ Phase 3完了確認完了（データ検証、E3カバレッジ確認）
- ✓ ESPnet2形式へのデータ変換スクリプト作成・実行完了
- ✓ 4条件すべてとテストセットのKaldi形式ファイル生成完了（wav.scp, text, utt2spk, spk2utt）
- ✓ fine-tuning設定ファイル作成完了（token_list, normalize, feats_extract, g2p, cleaner設定追加）
- ✓ train.pyの実装完了（ESPnet2のtts_train.py呼び出し、全条件ループ処理、統計情報収集とFine-tuningの2ステップ実行、学習時間記録機能を実装）
- ✓ 事前学習モデルのダウンロード完了（downloads/0afe7c220cac7d9893eea4ff1e4ca64e/exp/tts_train_tacotron2_raw_phn_jaconv_pyopenjtalk_accent_with_pause/train.loss.ave_5best.pth、103MB）
- ✓ train.pyのデフォルトパス更新完了（実際のダウンロード後のパス構造に対応、動的検索機能も追加）
- ✓ GPU OOM対策完了（batch_bins: 3750000 → 500000に削減、クラッシュ回避成功）
- ✓ E2（4文コーパス）でfine-tuning小規模テスト実行成功
  - 統計情報収集（Step 1）成功
  - Fine-tuning（Step 2）成功（Epoch 2まで完了）
  - 1エポックあたり約4分30秒（100エポックで約7.5時間）
  - Loss改善傾向確認（Epoch 1: 4.323 → Epoch 2: 3.093）
- ✓ 学習進捗監視スクリプト作成完了
- ✓ 自動再開スクリプト作成完了
- ✓ 学習停止問題の調査・分析完了（WSLのシンボリックリンク制限が原因）
- ✓ max_epochを10に変更（時間制約のため、80コーパスも実験可能）
- ✓ E2（train_4sent_37phonemes）の10エポック学習完了（2026年1月19日 21:35、所要時間: 約45分）
- ✓ E3（train_4sent_random）の10エポック学習完了（2026年1月20日 00:14、所要時間: 37分46秒）
- ✓ E4（train_10sent_top）の10エポック学習完了（2026年1月20日 01:11、所要時間: 56分9秒）
- ✓ E1（train_80sent）の10エポック学習完了（2026年1月20日 01:48、所要時間: 37分40秒）
- ✓ Phase 4全条件完了（E1, E2, E3, E4すべて10エポック達成、チェックポイント保存済み）
- ⚠️ WSL環境のシンボリックリンク制限により、各エポック完了時にPermissionError発生（学習自体は正常に動作、チェックポイントは保存される、自動再開スクリプトで対応）


**想定との差分**
- E3コーパスの選定方法を変更する必要が生じた（ランダム選定では対照実験として不適切）
- Phase 4の実装を段階的に進める方針に変更（Step 1-2完了、Step 4の一部完了）
- ESPnet2形式へのデータ変換が予想以上にスムーズに完了
- 事前学習モデルのダウンロード後のパス構造が想定と異なる（ハッシュ値ディレクトリ`0afe7c220cac7d9893eea4ff1e4ca64e`）が、動的検索機能で対応
- GPU OOM発生 → batch_binsを大幅に削減（3750000 → 500000）する必要が生じた
- 設定ファイルにtoken_list, normalize, feats_extract等の設定を追加する必要が生じた（事前に想定していなかった）
- WSL環境のシンボリックリンク制限により、学習停止問題が発生（自動再開スクリプトで対応）
- 時間制約により、max_epochを100から10に削減（4文コーパス: 約45分、80文コーパスも実験可能、すべての条件で同じエポック数に統一）


#### Action（改善）

**次回変えること**
1. ✅ 事前学習モデルのダウンロード完了
2. ✅ train.pyの実装拡張完了（ESPnet2のtts_train.py呼び出し、--resume対応）
3. ✅ E2（4文）で小規模テスト実行完了（データ形式と学習プロセスの確認完了）
4. ✅ GPU OOM対策完了（batch_bins削減）
5. ✅ 設定ファイル完成（token_list, normalize等の設定追加）
6. ✅ 学習進捗監視・自動再開機能追加
7. ✅ E2（4文コーパス）の10エポック完了（2026年1月19日 21:35完了）
8. ✅ E3（低カバレッジ4文）の10エポック完了（2026年1月20日 00:14完了）
9. ✅ E4（上位10文）の10エポック完了（2026年1月20日 01:11完了）
10. ✅ E1（80文コーパス）の10エポック完了（2026年1月20日 01:48完了）
11. Phase 5（音声合成）の実装開始
12. Phase 6（客観評価）の実装開始

---

### 2026年1月19日（月）Day 5

#### Plan（計画）

**今日のゴール**
- Phase 4の残り2条件（E3, E4）のfine-tuning完了
- Phase 4全条件完了

**やるタスク**（設計レベルメモ Phase 4参照）
- [ ] `scripts/run_experiment_4sent_random.sh`の作成
- [ ] `scripts/run_experiment_10sent_top.sh`の作成
- [ ] E3（低カバレッジ4文）のfine-tuning実行
- [ ] E4（上位10文）のfine-tuning実行
- [ ] 各条件の学習ログ確認（損失の推移、収束状況）
- [ ] チェックポイントの保存確認
- [ ] チェックポイントからモデルを読み込んで推論可能か確認

**詰まりそうなポイント**
- GPU OOM（影響度：中）→ バッチサイズ削減、mixed precision (fp16)使用
- 学習が収束しない（影響度：中）→ 学習率を1/10に下げる、ステップ数調整
- Fine-tuning時間超過（影響度：高）→ ステップ数削減、条件数削減（ランダム4文を除外）

#### Do（実行）

実行ログ（時間＋内容）:
```
[時刻] 
[時刻] 
[時刻] 
[時刻] 
[時刻] 
```

#### Check（確認）

**できたこと / できなかったこと**
- 


**想定との差分**
- 


#### Action（改善）

**次回変えること**
1. 
2. 
3. 

---

### 2026年1月20日（火）Day 6

#### Plan（計画）

**今日のゴール**
- Phase 5（音声合成）完了
- Phase 6（客観評価）完了（最低MCD, F0 RMSE）
- マイルストーン3達成

**やるタスク**（設計レベルメモ Phase 5, 6参照）
- [x] `src/synthesize.py`の作成（音声合成スクリプト）
- [x] テストセットのテキスト読み込み
- [x] 各条件のチェックポイントからモデル読み込み
- [x] 音声合成の実行（各条件×各テスト文）
- [x] 合成音声の保存（`outputs/audio/<condition>/<sentence_id>.wav`）
- [x] 合成時間の記録（`logs/synthesis_<condition>.json`）
- [x] 全条件での音声合成実行（18文×4条件=72ファイル）
- [x] `src/evaluate.py`の作成（客観評価スクリプト）
- [x] MCD算出スクリプトの実装（ESPnet2の評価ツールを参考に実装）
- [x] log-F0 RMSE算出スクリプトの実装（pyworldを使用して実装）
- [x] `src/evaluate_all_conditions.py`の作成（4条件一括評価スクリプト）
- [ ] 全条件×全テスト文の評価実行（10epoch学習完了後）
- [ ] 評価結果の保存（`results/evaluation_results.json`）

**詰まりそうなポイント**
- 合成音声が生成されない（影響度：高）→ チェックポイント確認、モデル読み込み確認、エラーログ確認
- 評価指標の計算エラー（影響度：中）→ 手動で1サンプル計算して検証、ESPnet2公式評価スクリプトと比較
- 評価未完了（影響度：高）→ MCD/F0のみに絞る（CERは削除）

#### Do（実行）

実行ログ（時間＋内容）:
```
[2026-01-20 02:45] src/synthesize.py作成完了（ESPnet2のText2Speechクラスを使用）
[2026-01-20 02:45] テストセットのdata.listからテキスト読み込み機能実装完了
[2026-01-20 02:45] 各条件のチェックポイント読み込み機能実装完了
[2026-01-20 02:45] E2（train_4sent_37phonemes）でテスト実行成功（18文すべて合成成功、所要時間: 13.64秒）
[2026-01-20 02:45] 全条件での音声合成実行開始
[2026-01-20 02:45] E1（train_80sent）完了（18文、所要時間: 46.49秒、平均2.44秒/文）
[2026-01-20 02:46] E2（train_4sent_37phonemes）完了（18文、所要時間: 46.14秒、平均2.45秒/文）
[2026-01-20 02:47] E3（train_4sent_random）完了（18文、所要時間: 43.27秒、平均2.28秒/文）
[2026-01-20 02:48] E4（train_10sent_top）完了（18文、所要時間: 45.58秒、平均2.41秒/文）
[2026-01-20 02:48] 全条件での音声合成完了（合計72ファイル生成成功）
```

#### Check（確認）

**できたこと / できなかったこと**
- ✓ src/synthesize.pyの作成完了（ESPnet2のText2Speechクラスを使用）
- ✓ テストセットのdata.listからテキスト読み込み機能実装完了
- ✓ 各条件のチェックポイント読み込み機能実装完了
- ✓ 音声合成実行機能実装完了（18文×4条件=72ファイル）
- ✓ 合成音声の保存機能実装完了（outputs/audio/<condition>/<sentence_id>.wav）
- ✓ 合成時間の記録機能実装完了（logs/synthesis_<condition>.json）
- ✓ 全条件での音声合成実行完了（合計72ファイル生成成功、すべて正常に生成）
- ✓ 全条件で18文ずつ正常に合成（ファイルサイズ: 約844KB/ファイル、正常に生成）
- ✓ Phase 6（客観評価）スクリプト実装完了（`src/evaluate.py`, `src/evaluate_all_conditions.py`）
- ⚠️ Phase 6（客観評価）の実行は10epoch学習完了後


**想定との差分**
- 音声合成の実行が想定以上にスムーズに完了（エラーなし、全72ファイル正常生成）
- 合成時間は1文あたり約2-3秒で、想定通り（全72ファイルで約3分程度）
- ESPnet2のText2Speechクラスが正常に動作し、チェックポイントからのモデル読み込みも成功
- テストセットのdata.listから元のテキストを読み込む方式に変更（音素列ではなくテキストを使用）

#### 追加調査（音声合成の失敗原因切り分け）

実行ログ（時間＋内容）:
```
[2026-01-20] ベースライン（事前学習）モデルで合成を実施し、読み上げが成立することを確認（outputs/audio/baseline/）
[2026-01-20] fine-tuning後モデルの出力が小振幅・一定音となる現象を確認
[2026-01-20] データ変換（Kaldi形式のtext）が音素列になっていたことを特定
[2026-01-20] src/convert_to_espnet2_format.py を修正し、Kaldi textを raw text に変更
[2026-01-20 18:40] raw textでの学習（exp_text/train_80sent）を1epoch実施し、合成振幅の改善を確認（outputs/audio/exp_text/exp_text_1epoch.wav, std=0.0328）
[2026-01-20 19:58-20:15] 全4条件で1epochテスト学習を実施
  - train_80sent: 1epoch (2分57.6秒), 合成振幅 std=0.0179
  - train_4sent_37phonemes: 1epoch (4分24.4秒), 合成振幅 std=0.0370
  - train_4sent_random: 1epoch (2分53.0秒), 合成振幅 std=0.0325
  - train_10sent_top: 1epoch (4分10.1秒), 合成振幅 std=0.0314
[2026-01-20 20:16] 10epoch本学習スクリプト（scripts/train_all_10epoch.sh）を実行開始
[2026-01-20 20:19-20:31] 各条件で1epoch学習は完了したが、シンボリックリンクエラー（PermissionError）により10epochまで到達せず
[2026-01-20] src/synthesize.py に --base_dir, --output_dir オプションを追加
[2026-01-20] scripts/run_all_synthesis.sh を修正し、exp_text対応を追加
[2026-01-20 夜間] src/train.pyにsymlinkエラー修正（WSL対応のfallback実装）を追加
[2026-01-20 夜間] src/evaluate.py実装完了（MCD、log-F0 RMSE計算）
[2026-01-20 夜間] src/evaluate_all_conditions.py実装完了（4条件一括評価）
[2026-01-21 01:00] 10epoch学習スクリプト実行開始（バックグラウンド実行）
[2026-01-21 01:35] 10epoch学習が1epochで停止していることを確認（symlinkエラーが原因）
[2026-01-21 01:35] ESPnet2のtrainer.pyを修正（symlinkエラー時にコピーで代替する処理を追加）
[2026-01-21 01:39] 10epoch学習を再開（--resumeオプション追加、音声合成自動実行も追加）
[2026-01-21 02:03-03:46] 全4条件で10epoch学習完了
  - train_80sent: 10epoch完了（02:03）
  - train_4sent_37phonemes: 10epoch完了（02:43）
  - train_4sent_random: 10epoch完了（03:09）
  - train_10sent_top: 10epoch完了（03:46）
[2026-01-21 03:46-03:47] 音声合成自動実行完了（72ファイル生成）
[2026-01-21 07:40] 10epoch学習後の音声合成が失敗している問題を特定
  - 原因: synthesize.pyがcheckpoint.pthを読み込んでいた（10epoch.pthが正しい）
  - 症状: mel spectrogramのshapeが(1, 80)と異常に小さい、音声ファイルが644バイト
[2026-01-21 07:58] src/synthesize.pyを修正（10epoch.pth > latest.pth > checkpoint.pthの優先順位で読み込み）
[2026-01-21 07:58-07:59] train_80sent, train_4sent_37phonemes, train_4sent_randomの音声合成再実行完了（正常に動作）
[2026-01-22 02:13] train_10sent_topの音声合成再実行完了（古いファイル削除後、正常に動作）
```


#### Action（改善）

**次回変えること**
1. ✅ Phase 5完了、Phase 6（客観評価）の実装開始
2. Phase 6でMCD, log-F0 RMSEの算出スクリプトを作成
3. 全条件×全テスト文の評価実行

---

### 2026年1月21日（水）Day 7

#### Plan（計画）

**今日のゴール**
- 10epoch学習の完了
- 全72ファイル音声合成の完了
- Phase 6（客観評価）の準備完了

**やるタスク**
- [x] 10epoch学習スクリプトの実行と完了確認
- [x] symlinkエラーによる学習停止問題の解決
- [x] 音声合成スクリプトの修正（10epoch.pthを優先的に使用）
- [x] 全条件での音声合成再実行（72ファイル）
- [ ] Phase 6（客観評価）の実行

**詰まりそうなポイント**
- symlinkエラーによる学習停止（影響度：高）→ ESPnet2のtrainer.pyを修正
- 10epoch学習後の音声合成失敗（影響度：高）→ チェックポイントファイルの選択ロジックを修正

#### Do（実行）

実行ログ（時間＋内容）:
```
[2026-01-21 01:00] 10epoch学習スクリプト実行開始（バックグラウンド実行）
[2026-01-21 01:35] 10epoch学習が1epochで停止していることを確認
  - 原因: ESPnet2のtrainer.pyでsymlinkエラー（PermissionError）が発生
  - 症状: 各条件で1epoch完了後に停止、10epoch.pthが生成されない
[2026-01-21 01:35] ESPnet2のtrainer.pyを修正
  - ファイル: espnet/espnet2/train/trainer.py（445行目、457行目）
  - 修正内容: symlink_to()をtry-exceptで囲み、エラー時はshutil.copy2()で代替
[2026-01-21 01:39] 10epoch学習を再開
  - scripts/train_all_10epoch.shに--resumeオプション自動追加機能を実装
  - 音声合成の自動実行も追加（学習完了後に自動実行）
[2026-01-21 02:03] train_80sent: 10epoch完了
[2026-01-21 02:43] train_4sent_37phonemes: 10epoch完了
[2026-01-21 03:09] train_4sent_random: 10epoch完了
[2026-01-21 03:46] train_10sent_top: 10epoch完了
[2026-01-21 03:46-03:47] 音声合成自動実行完了（72ファイル生成）
[2026-01-21 07:40] 10epoch学習後の音声合成が失敗している問題を確認
  - train_80sent, train_4sent_37phonemes, train_4sent_random: 音声ファイルが644バイトと異常に小さい
  - train_10sent_top: 正常（1エポック学習時のファイルが残っていた）
  - 原因: synthesize.pyがcheckpoint.pth（306MB）を読み込んでいた
  - 正しいファイル: 10epoch.pth（103MB）が10エポック完了時の最終モデル
[2026-01-21 07:58] src/synthesize.pyを修正
  - チェックポイントファイルの優先順位を変更: 10epoch.pth > latest.pth > checkpoint.pth
  - 修正箇所: 111行目のチェックポイントファイル選択ロジック
[2026-01-21 07:58] train_80sentの音声合成再実行完了（正常に動作）
  - mel spectrogramのshape: 391-743フレーム（正常）
  - ファイルサイズ: 261KB-309KB（正常）
[2026-01-21 07:59] train_4sent_37phonemes, train_4sent_randomの音声合成再実行完了（正常に動作）
[2026-01-22 02:13] train_10sent_topの音声合成再実行完了（古いファイル削除後、正常に動作）
  - ファイルサイズ: 200KB-342KB（正常、以前の844KB-1.4MBより適切）
```

#### Check（確認）

**できたこと / できなかったこと**
- ✓ 10epoch学習完了（全4条件、exp_text/*/10epoch.pthが生成）
- ✓ symlinkエラー問題の解決（ESPnet2のtrainer.py修正）
- ✓ 10epoch学習後の音声合成失敗問題の解決（synthesize.py修正）
- ✓ 全72ファイル音声合成完了（全4条件で18文ずつ正常に生成）
- ✓ 音声ファイルの品質確認（mel spectrogramのshape、ファイルサイズ、振幅が正常）
- ✓ Phase 6（客観評価）の実行完了（2026-01-22）
  - 評価スクリプト（evaluate_all_conditions.py）の実行完了
  - 全4条件の評価結果取得完了
  - MCD値の計算完了（train_80sent: 5.0490 dB, train_4sent_37phonemes: 5.2273 dB, train_4sent_random: 5.2660 dB, train_10sent_top: 5.1021 dB）
  - 評価結果の保存完了（results/evaluation_results.json, results/evaluation_summary.csv）
  - 音声品質の主観的考察の記録完了

**想定との差分**
- 10epoch学習が1epochで停止する問題が発生（symlinkエラーが原因）
- ESPnet2のtrainer.pyを直接修正する必要があった（想定外）
- 10epoch学習後の音声合成が失敗する問題が発生（checkpoint.pthと10epoch.pthの違いが原因）
- synthesize.pyのチェックポイント選択ロジックを修正する必要があった
- **条件間で大きな品質差が感じられなかった点**（MCDの差は約0.22 dBと小さい）
- **音程が中間的になった点**（事前学習モデルとターゲット話者の中間的な特徴空間に収束）

**学んだこと**
- 10エポックでは完全な話者適応には不十分である可能性（完全にjvs002の低音特徴を学習しきれていない）
- F0（基本周波数）の学習難易度が高く、より多くのエポック数が必要である可能性（20-50エポック以上）
- 少量データでのFine-tuningの限界と、Transfer Learningの特性（事前学習モデルとターゲット話者の中間的な特徴空間に収束）
- 客観評価（特にlog-F0 RMSE）で、この仮説を数値的に検証できる可能性がある（ただし、今回は計算に問題があり`inf`となった）

#### Action（改善）

**次回変えること**
1. ✅ 10epoch学習完了、全72ファイル音声合成完了
2. Phase 6（客観評価）の実行（MCD、log-F0 RMSE計算）
3. 評価結果の可視化と分析 

---

### 2026年1月22日（木）Day 8

#### Plan（計画）

**今日のゴール**
- log-F0 RMSE修正完了
- Phase 7（結果可視化）完了
- 結果レポート作成完了
- マイルストーン4達成、プロジェクト完了

**やるタスク**（設計レベルメモ Phase 7参照）
- [x] log-F0 RMSE計算エラーの診断と修正（DTWアライメント追加）
- [x] 修正後の評価スクリプトを実行してlog-F0 RMSEが有限値になることを確認
- [x] Phase 7（結果可視化）スクリプトの作成（4種類のグラフ生成）
- [x] 結果レポート（results.md）の作成
- [x] 開発ログ（development_log.md）にセッション10を追加
- [x] PDCAチェックリストとdevelopment_planの更新
- [ ] README.mdの最終更新（使用方法、実験結果の概要、リポジトリ構造の説明）
- [ ] 最終確認（すべてのスクリプトが実行可能か、ドキュメントに不足がないか、結果ファイルが揃っているか）

**詰まりそうなポイント**
- log-F0 RMSE修正に時間がかかる可能性（影響度：高）→ DTWアライメントを使用する方法で解決
- ドキュメント整備の時間不足（影響度：低）→ 最低限のREADMEとresults.mdを優先

#### Do（実行）

実行ログ（時間＋内容）:
```
[2026-01-22] log-F0 RMSE計算エラーの診断完了（DTWアライメント未使用が原因）
[2026-01-22] src/evaluate.pyのcalculate_log_f0_rmse関数を修正（DTWアライメント追加）
[2026-01-22] 修正後の評価スクリプトを実行、log-F0 RMSEが正常に計算されることを確認
  - train_80sent: 0.2573
  - train_4sent_37phonemes: 0.3364
  - train_4sent_random: 0.3296
  - train_10sent_top: 0.2646
[2026-01-22] src/visualize.pyを作成（4種類のグラフ生成機能を実装）
[2026-01-22] Phase 7（結果可視化）を実行、すべてのグラフを正常に生成（英語ラベルで生成）
  - MCD比較棒グラフ
  - log-F0 RMSE比較棒グラフ
  - 音素カバレッジとMCDの散布図
  - データ量とMCDの散布図
[2026-01-22] グラフの日本語ラベルを英語に変更（フォント問題を回避）
[2026-01-22] docs/results.mdを作成（実験結果レポート）
[2026-01-22] docs/development_log.mdにセッション10を追加
[2026-01-22] docs/pdca_checklist.mdとdocs/development_plan.mdを更新
```

#### Check（確認）

**できたこと / できなかったこと**
- ✓ log-F0 RMSE計算エラーの診断と修正完了（DTWアライメント追加）
- ✓ 修正後の評価スクリプトを実行、log-F0 RMSEが正常に計算されることを確認
- ✓ Phase 7（結果可視化）スクリプトの作成完了（4種類のグラフ生成、英語ラベルで生成）
- ✓ 結果レポート（results.md）の作成完了
- ✓ 開発ログ（development_log.md）にセッション10を追加完了
- ✓ PDCAチェックリストとdevelopment_planの更新完了
- ⚠️ README.mdの最終更新は未完了（次のステップ）

**想定との差分**
- log-F0 RMSEの初期実装でDTWアライメントを使用していなかったため、修正に時間がかかった
- 修正後は正常に動作し、すべての条件で有限値が得られた
- 可視化スクリプトの作成は想定通り完了
- 結果レポートの作成は想定通り完了

**学んだこと**
- F0評価の実装は予想以上に複雑で、DTWアライメントが必要であることが分かった
- 有声音フレームのマッチングには、時間軸のアライメントが重要である
- 客観評価と主観評価のギャップ（MCDでは差が小さいが、主観的には音程の違いを感じる）
- 10エポックという少ないエポック数での話者適応の限界が数値で裏付けられた

#### Action（改善）

**次回変えること**
1. ✅ log-F0 RMSE修正完了、Phase 7完了、結果レポート作成完了
2. README.mdの最終更新（使用方法、実験結果の概要、リポジトリ構造の説明）
3. 最終確認（すべてのスクリプトが実行可能か、ドキュメントに不足がないか、結果ファイルが揃っているか）

---

## 週次振り返り

### 今週の成果
- 


### 今週の課題
- 


### 来週への改善点
- 


---

## 変更履歴

| Date | Version | Changes |
|------|---------|---------|
| 2026-01-15 | 1.0 | 初版作成 |
| 2026-01-18 | 1.1 | Phase 1-3のスクリプト作成完了、PDCAチェックリスト更新 |
| 2026-01-18 | 1.2 | Phase 2完了（音素分析・コーパス選定実行完了）、Day 2のPDCA更新 |
| 2026-01-18 | 1.3 | Phase 3完了（データ前処理実行完了）、Day 3のPDCA更新、Phase 4のPlan作成 |
| 2026-01-18 | 1.4 | E3コーパス選定方法変更、Phase 4実装開始（データ形式変換スクリプト作成・実行、設定ファイル作成）、Day 4のPDCA更新 |
| 2026-01-19 | 1.5 | train.py実装完成、事前学習モデルダウンロード完了、パス設定更新、Day 4のPDCA更新（完了タスク追加） |
| 2026-01-19 | 1.6 | E2 fine-tuningテスト実行、GPU OOM解決（batch_bins削減）、設定ファイル完成、学習進捗監視ツール作成、学習停止問題調査、max_epochを20に変更、Day 4のPDCA更新（実行ログ・成果追加） |
| 2026-01-19 | 1.7 | max_epochを10に変更（80コーパスも対照実験として実行するため）、.gitignore更新（exp/とlogs/*.jsonを追加） |
| 2026-01-19 | 1.8 | E2（train_4sent_37phonemes）の10エポック学習完了（自動再開スクリプト使用）、Day 4のPDCA更新（実行ログ・成果追加） |
| 2026-01-20 | 1.9 | 連続実行スクリプト作成、残り3条件（E3, E4, E1）の学習完了、Phase 4全条件完了、Day 4のPDCA更新（実行ログ・成果追加） |
| 2026-01-20 | 2.0 | Phase 5完了（音声合成スクリプト作成、全4条件で18文ずつ音声合成完了、合計72ファイル生成）、Day 6のPDCA更新（実行ログ・成果追加） |
| 2026-01-20 | 2.1 | データ形式修正（raw text対応）、1epochテスト学習完了、10epoch学習の課題（symlinkエラー）を特定、現状まとめをドキュメント更新 |
| 2026-01-21 | 2.2 | 夜間実行タスク: symlinkエラー修正（ESPnet2のtrainer.py修正）、10epoch学習完了、音声合成失敗の原因特定と修正（checkpoint.pth vs 10epoch.pth）、全72ファイル正常生成完了、Day 7のPDCA更新 |